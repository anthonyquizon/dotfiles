scripte utf-8 
set shell=/bin/bash
set nocompatible autoindent laststatus=2 relativenumber nu smartcase nopaste nowrap expandtab hidden
set noswapfile nobackup nowritebackup shiftwidth=4 softtabstop=4 tabstop=4 is ttimeoutlen=100   " ttimeout to stop esc hanging on : commands
set backspace=indent,eol,start hlsearch path+=** wildmenu autoread undofile undodir=~/.vim/undodir 
set grepprg=rg\ --vimgrep|set complete= |set grepformat^=%f:%l:%c:%m|set viminfo='50,<5000,s100  " increase vim register limit so that we can copy more data between instances 
au FileType python setlocal noexpandtab softtabstop=4 tabstop=4 shiftwidth=4
au FileType c setlocal noexpandtab softtabstop=2 tabstop=2 shiftwidth=2
let g:netrw_banner = 0 | let mapleader = "\<Space>"
filetype indent on | syntax on | filetype plugin on
au FileType yaml setlocal ai< ci< si< 
ino jk <esc>| nn K <nop>| nn U <nop>
com! Qa qa | com! QA qa | com! Q q|                                                             " typo friendly commands. 'w' commands are separate lines (not |) Parser treats | as filename
com! WQ wq
com! Wq wq
com! W w
com! E Explore|                                                                                 " Enforce Explore shorthand command (in case of ambiguity eg. Emmet)
vm < <gv | vm > >gv|                                                                            " visual mode indenting
vn <leader>s "vy :%s/<C-R>v//g<Left><Left>|                                                     " search visual
vn <leader>S "vy :%s//<C-R>v/g<C-b><Right><Right><Right>|                                       " search visual
nn <leader>s :%sno/<C-R><C-W>//g<Left><Left>|                                                   " search
nn <leader>S :%sno//<C-R><C-W>/g<C-b><Right><Right><Right><Right><Right>|                       " search 
nn <leader>z :noh<CR>                                                                           " search  highlight
nn <leader>0 :set scroll=0<CR>                                                                  " scroll reset
vn  <C-y> "*y                                                                                   " yank into clipboard 
vn  <C-p> "*p                                                                                   " paste from clipboard 
nn  <C-j> :m .+1<CR>==| nn <C-k> :m .-2<CR>==|                                                  " shuffle line one up or down Normal mode
ino <C-j> <Esc>:m .+1<CR>==gi| ino <C-k> <Esc>:m .-2<CR>==gi|                                   " shuffle line one up or down Insert mode
vn  <C-j> :m '>+1<CR>gv=gv| vn <C-k> :m '<-2<CR>gv=gv|                                          " shuffle line one up or down Visual mode
nn <C-w>v :echo "disabled"<CR>
nn <C-w>s :echo "disabled"<CR>
nor <leader>; :call nerdcommenter#Comment(1, 'toggle')<CR>|                                     " NERD commenter installed in setup.sh
nn <leader><leader> :FuzzyFilesRoot<CR>|                              
nn <leader>/ :FuzzyGrep<CR>|
nn <leader>c :FuzzyCommandHistory<CR>|
nn <leader>? :FuzzyInBuffer<CR>|
nn <leader>m :FuzzyMruRoot<CR>|
cno <C-a> <Home>
cno <C-e> <End>
let g:fuzzyy_keymaps = {'preview_up_half_page':[], 'delete_all': ["\<c-u>"]}
fu! WriteTmpPath()
  let dir = system('git rev-parse --show-toplevel | md5')
  let dir = substitute(l:dir, '\n', '', 'g')
  call writefile([expand('%:p')], '/tmp/' . dir)
endf
au BufNewFile,BufRead,ModeChanged,FocusGained * :call WriteTmpPath()
au VimEnter,FocusGained * rviminfo!
au VimLeave,FocusLost * wviminfo
" BQN
let a ='`1234567890-= ~!@#$%^&*()_+ qwertyuiop[]  QWERTYUIOP{} asdfghjkl;''\ ASDFGHJKL:"| zxcvbnm,./    ZXCVBNM<>?   '
let b ='ËœË˜Â¨â¼âŒœÂ´Ë7âˆÂ¯â€¢Ã·Ã— Â¬â‰âš‡âŸâ—¶âŠ˜âŠââ•âŸ¨âŸ©âˆšâ‹† âŒ½ğ•¨âˆŠâ†‘âˆ§yâŠ”âŠâŠÏ€â†â†’  â†™ğ•â·ğ•£â‹YUâŠ‘âŠ’â³âŠ£âŠ¢ â‰ğ•¤â†•ğ•—ğ•˜âŠ¸âˆ˜â—‹âŸœâ‹„â†©\  â†–ğ•ŠDğ”½ğ”¾Â«JâŒ¾Â»Â·Ë™| â¥Šğ•©â†“âˆ¨âŒŠnâ‰¡âˆ¾â‰â‰     â‹ˆğ•Câ’âŒˆNâ‰¢â‰¤â‰¥â‡   '
let c ='SsTtonkNyr0123)!@#*'
let d ="â– â–¡â—€â—â—‹â‚™âœ“â¿â˜ºâ†ºâ‚€â‚â‚‚â‚ƒâ°Â¹Â²Â³ê˜"
let[a,b]=map([a,b],{i,x->split(x,'\zs *')}) | let a+=['<space>']|let b+=['â€¿']
for l in ['i','c']|for i in range(len(a))|exe escape(l.'no'.'\'.a[i].' '.b[i],'|')|endfor|endfor
for l in ['i','c']|for i in range(len(c))|exe escape(l.'no'.'|'.c[i].' '.matchstr(d,'.',0,i+1),'|')|endfor|endfor
unl a b c d l i
au BufRead,BufNewFile * if getline(1) =~ '^#!.*bqn$' | setf bqn | endif
au BufRead,BufNewFile *.bqn setf bqn
au FileType bqn syn match bqncom "#.*$"
au FileType bqn hi link bqncom comment
au FileType bqn setlocal softtabstop=2 tabstop=2 shiftwidth=2 expandtab cms=#%s
fu FmtBQN() 
    let c=join(getline(1, '$'), "\n")
    let t=tempname()
    let f=<<EOF 
    [a,b]â†â‰>{2â†‘ğ•©âŠ”Ëœ1âŒŠ+`'#'=ğ•©}Â¨â€¢FLines "/dev/stdin" # separate code (a) and comments (b)
    mâ†{Â¬âˆ§Â´' 'âŠ¸=ğ•©}Â¨a                               # remove tail whitespace from code
    aâ†©{âŒ½(âˆ¨`' 'âŠ¸â‰ )âŠ¸/âŒ½ğ•©}Â¨âŒ¾(mâŠ¸/)a
    sâ†' 'Â¨Â¨â†•Â¨(mâˆ§(0â‰ â‰ Â¨b)âˆ§0â‰ â‰ Â¨a)Ã—1+(âŒˆÂ´â‰ Â¨a)-â‰ Â¨a      # calculate comment prefix whitespace 
    â€¢Out 1â†“âˆ¾âˆ¾(@+10)âŠ¸âˆ¾Â¨<Ë˜â‰[a,sâˆ¾Â¨b]                 # prepend whitespace and recombine code and comments
EOF
    call writefile(f, t)
    let o = system('bqn '. t, c)
    call setline(1, split(o, "\n",1))
    call delete(t)
endf
nor <leader>ff :call FmtBQN()<CR>
